var ilabAttachmentInfo=function(t,e,a){var n=this;this.info=t(e.attachmentTemplate(a)),this.data=a,this.attachmentTitle=this.info.find('input[name="attachment-title"]'),this.attachmentCaption=this.info.find('textarea[name="attachment-caption"]'),this.attachmentAlt=this.info.find('input[name="attachment-alt"]'),this.attachmentDescription=this.info.find('textarea[name="attachment-description"]'),this.attachmentAlign=this.info.find('select[name="attachment-align"]'),this.attachmentLinkURL=this.info.find('input[name="attachment-link-url"]'),this.attachmentSize=this.info.find('select[name="attachment-size"]'),this.attachmentLinkType=this.info.find('select[name="attachment-link-type"]'),this.saveToken=null;var i=function(){var e={action:"save-attachment",id:n.data.id,nonce:n.data.nonces.update,post_id:window.parent.wp.media.model.settings.post.id,"changes[title]":n.attachmentTitle.val(),"changes[caption]":n.attachmentCaption.val(),"changes[alt]":n.attachmentAlt.val(),"changes[description]":n.attachmentDescription.val()};t.post(ajaxurl,e,function(t){console.log(t)})};this.save=function(){clearTimeout(n.saveToken),n.saveToken=setTimeout(i,1e3)};var o=function(t){n.save()};this.attachmentTitle.on("change",o),this.attachmentCaption.on("change",o),this.attachmentAlt.on("change",o),this.attachmentDescription.on("change",o),this.attachmentLinkType.on("change",function(){var t=n.attachmentLinkType.val();"none"==t?(n.attachmentLinkURL.css({display:"display"}),n.attachmentLinkURL.val("")):"file"==t?(n.attachmentLinkURL.prop("readonly","readonly"),n.attachmentLinkURL.css({display:""}),n.attachmentLinkURL.val(n.data.url)):"post"==t?(n.attachmentLinkURL.prop("readonly","readonly"),n.attachmentLinkURL.css({display:""}),n.attachmentLinkURL.val(n.data.link)):"custom"==t&&(n.attachmentLinkURL.prop("readonly",null),n.attachmentLinkURL.css({display:""}),n.attachmentLinkURL.val(""))}),this.insert=function(){var e={action:"send-attachment-to-editor","attachment[id]":n.data.id,nonce:window.parent.wp.media.view.settings.nonce.sendToEditor,post_id:window.parent.wp.media.model.settings.post.id,"attachment[post_content]":n.attachmentDescription.val(),"attachment[post_excerpt]":n.attachmentCaption.val(),"attachment[image_alt]":n.attachmentAlt.val(),"attachment[image-size]":n.attachmentSize.val(),"attachment[align]":n.attachmentAlign.val(),"attachment[url]":n.attachmentLinkURL.val(),html:""};t.post(ajaxurl,e,function(t){console.log(t),t.hasOwnProperty("data")&&window.parent.send_to_editor(t.data)})},this.attachmentLinkURL.css({display:"none"}),e.attachmentContainer.empty(),e.attachmentContainer.append(this.info)},ilabMediaUploadItem=function(t,e,a){var n=this;this.cell=t(e.uploadItemTemplate()),this.background=this.cell.find(".ilab-upload-item-background"),this.status=this.cell.find(".ilab-upload-status"),this.progress=this.cell.find(".ilab-upload-progress"),this.progressTrack=this.cell.find(".ilab-upload-progress-track"),this.status.text("Waiting ..."),this.progressTrack.css({width:"0%"}),this.cell.css({opacity:0}),this.cell.addClass("no-mouse"),this.state="waiting",this.postId=null,this.loader=this.cell.find(".ilab-loader-container"),0==a.type.indexOf("image/")&&a.size<15728640?this.background.css({opacity:.33,"background-image":"url("+URL.createObjectURL(a)+")"}):0==a.type.indexOf("image/")?this.cell.addClass("ilab-upload-cell-image"):0==a.type.indexOf("video/")?this.cell.addClass("ilab-upload-cell-video"):"application/x-photoshop"==a.type?this.cell.addClass("ilab-upload-cell-image"):this.cell.addClass("ilab-upload-cell-doc"),this.deselect=function(){this.cell.removeClass("ilab-upload-selected")},this.startUpload=function(){var i={action:"ilab_upload_prepare",filename:a.name};t.post(ajaxurl,i,function(i){if(console.log(i),"ready"==i.status){n.status.text("Uploading ...");var o=new FormData;_.each(Object.keys(i.inputs),function(t){"key"!=t&&o.append(t,i.inputs[t])}),null!=i.cacheControl&&o.append("Cache-Control",i.cacheControl),null!=i.expires&&o.append("Expires",i.expires);var s=a.type;"application/x-photoshop"==s&&(s="image/psd"),o.append("Content-Type",s),o.append("acl","public-read"),o.append("key",i.key),o.append("file",a),t.ajax({url:i.attr.action,method:"POST",contentType:!1,processData:!1,data:o,xhr:function(){var e=t.ajaxSettings.xhr();return e.upload.onprogress=function(t){n.progressTrack.css({width:Math.floor(t.loaded/t.total*100)+"%"})},e},success:function(a){var o={action:"ilab_upload_import_s3_file",key:i.key};t.post(ajaxurl,o,function(t){if(console.log(t),"success"==t.status){if(n.progress.css({display:"none"}),n.status.css({display:"none"}),n.background.css({opacity:""}),n.state="ready",n.postId=t.data.id,t.data.thumb){n.loader.css({opacity:1});var a=new Image;a.onload=function(){console.log("image loaded"),n.background.css({"background-image":"url("+t.data.thumb+")"}),n.loader.css({opacity:0})},a.src=t.data.thumb}n.cell.removeClass("no-mouse")}else n.progress.css({display:"none"}),n.status.text("Error."),n.cell.addClass("upload-error");e.uploadFinished(n)})},error:function(t){n.progress.css({display:"none"}),n.status.text("Error uploading."),e.uploadFinished(n)}})}else e.uploadFinished(n),n.progress.css({display:"none"}),n.status.text("Error uploading.")})},e.uploadTarget.append(this.cell),setTimeout(function(){n.cell.css({opacity:""})},1e3/30),this.cell.on("click",function(t){if("ready"==n.state)if(e.settings.insertMode)n.cell.addClass("ilab-upload-selected"),e.uploadSelected(n);else{var a=window.open("post.php?post="+n.postId+"&action=edit","_blank");a.focus()}return t.preventDefault(),!1})},ilabMediaUploader=function(t,e){var a=this;console.log(e),this.insertButton=t("#ilab-insert-button"),this.settings=e,this.uploadTarget=t("#ilab-video-upload-target"),this.attachmentContainer=t("#ilab-attachment-info"),this.uploadDirections=this.uploadTarget.find(".ilab-upload-directions"),this.uploadItemTemplate=wp.template("ilab-upload-cell"),this.attachmentTemplate=wp.template("ilab-attachment-info"),this.hiddenFileInput=t('<input type="file" style="visibility:hidden" multiple="multiple">'),this.waitingQueue=[],this.uploadingQueue=[],this.watchToken=null,this.currentSelection=null,this.attachmentInfo=null,this.watchQueue=function(){if(a.uploadingQueue.length<5&&a.waitingQueue.length>0)for(var t=5-a.uploadingQueue.length,e=0;e<t;e++)if(a.waitingQueue.length>0){var n=a.waitingQueue.shift();a.uploadingQueue.push(n),n.startUpload()}a.watchToken=setTimeout(a.watchQueue,500)},this.uploadSelected=function(e){if(a.currentSelection!=e){a.insertButton.prop("disabled",!0),a.currentSelection&&a.currentSelection.deselect(),a.currentSelection=e;var n={action:"ilab_upload_attachment_info",postId:e.postId};t.post(ajaxurl,n,function(e){console.log(e),t("body").addClass("ilab-item-selected"),a.attachmentInfo=new ilabAttachmentInfo(t,a,e),a.insertButton.prop("disabled",!1)})}},this.uploadFinished=function(t){var e=a.uploadingQueue.indexOf(t);e>-1&&a.uploadingQueue.splice(e,1),clearTimeout(a.watchToken),a.watchQueue()},this.addFile=function(n){if(console.log(n),""==n.type)return console.log("Missing file type."),!1;var i=n.type;if("application/x-photoshop"==i&&(i="image/psd"),-1==e.allowedMimes.indexOf(i))return console.log("Mime-type "+i+" not allowed."),!1;var o=i.split("/"),s=o[0],l=o[1];if("image"==s){if(!e.imgixEnabled)return console.log("Image files not allowed."),!1;if(-1==["jpeg","gif","png"].indexOf(l)){if(!e.extrasEnabled)return console.log("Non-standard image files not allowed."),!1;if(-1==["psd","tiff","bmp"].indexOf(l))return console.log("Invalid subtype."),!1}}else if("video"==s){if(!e.videoEnabled)return console.log("Video not allowed."),!1}else if(!e.docsEnabled)return console.log("Docs not allowed."),!1;console.log(["accepted",n]),a.waitingQueue.push(new ilabMediaUploadItem(t,a,n))},this.uploadTarget.on("dragenter dragover",function(t){a.uploadTarget.addClass("drag-inside"),t.stopPropagation(),t.preventDefault()}),this.uploadTarget.on("dragleave drageexit",function(t){a.uploadTarget.removeClass("drag-inside"),t.stopPropagation(),t.preventDefault()}),this.uploadTarget.on("drop",function(t){a.uploadTarget.removeClass("drag-inside"),a.uploadDirections.css({display:"none"}),t.preventDefault();var e=t.originalEvent.dataTransfer.files;_.each(e,a.addFile)}),this.uploadTarget.on("click",function(t){a.hiddenFileInput.click()}),this.hiddenFileInput.on("change",function(t){a.uploadDirections.css({display:"none"});for(var e=0;e<this.files.length;e++)a.addFile(this.files[e])}),t("#ilab-open-editor").on("click",function(t){return wp.media({frame:"select"}).open(),t.preventDefault(),!1}),this.insertButton.on("click",function(t){return a.attachmentInfo&&a.attachmentInfo.insert(),t.preventDefault(),!1}),e.insertMode&&t("body").addClass("ilab-upload-insert-mode"),this.watchToken=setTimeout(this.watchQueue,500)};
//# sourceMappingURL=ilab-media-upload.js.map
